<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - RT App</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        
        p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #0056CC;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .app-instructions {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007AFF;
        }
        
        .app-instructions h3 {
            margin-top: 0;
            color: #333;
            font-size: 16px;
        }
        
        .app-instructions p {
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .step-number {
            display: inline-block;
            background-color: #007AFF;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reset Your Password</h1>
        <p>Enter your new password below</p>
        
        <div id="message"></div>
        
        <form id="resetForm">
            <div class="form-group">
                <label for="password">New Password</label>
                <input type="password" id="password" name="password" required minlength="6" placeholder="Enter at least 6 characters">
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6" placeholder="Re-enter your password">
            </div>
            
            <button type="submit" id="submitBtn">Update Password</button>
        </form>
        
        <div class="app-instructions" id="successInstructions" style="display: none;">
            <h3>✅ Password Updated Successfully!</h3>
            <p><span class="step-number">1</span>Open the RT app on your device</p>
            <p><span class="step-number">2</span>Sign in with your email and new password</p>
            <p><span class="step-number">3</span>You're all set!</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase - using the same configuration as your app
        const config = {
            supabaseUrl: 'https://lxcbundvozbcshjboloc.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4Y2J1bmR2b3piY3NoamJvbG9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2Njg4NjcsImV4cCI6MjA3NTI0NDg2N30.j445kI35RNKTcnYiCyzeWovaW4lT5IxT9tuc_zOq30I'
        }
        
        const { createClient } = supabase
        const supabaseClient = createClient(config.supabaseUrl, config.supabaseKey, {
            auth: {
                detectSessionInUrl: true,
                flowType: 'pkce',
                autoRefreshToken: true
            }
        })

        // Initialize the page
        const messageDiv = document.getElementById('message')
        
        // Show loading state initially
        messageDiv.innerHTML = '<div style="text-align: center; color: #666;">Validating reset link...</div>'
        
        console.log('Page loaded, URL:', window.location.href);
        
        // Test if this page is accessible at all
        console.log('Page accessibility test: PASS');
        console.log('Supabase client initialized:', !!supabaseClient);
        
        // Add debug info about the page load
        console.log('Referrer:', document.referrer);
        console.log('User agent:', navigator.userAgent);
        
        // Add auth state change listener to see what's happening
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state change:', event, session);
            if (event === 'PASSWORD_RECOVERY') {
                console.log('Password recovery event detected!');
                messageDiv.innerHTML = '<div class="success">Reset link validated. You can now set your new password.</div>'
            } else if (event === 'SIGNED_IN' && session) {
                console.log('User signed in during password recovery');
                messageDiv.innerHTML = '<div class="success">Reset link validated. You can now set your new password.</div>'
            }
        });
        
        // Check if we're being redirected from Supabase verify endpoint
        console.log('Checking URL for redirect parameters...');
        
        // First, let's see if we can detect any Supabase-related URL patterns
        const urlString = window.location.href;
        if (urlString.includes('#')) {
            console.log('URL contains hash - possible token redirect');
        }
        if (urlString.includes('access_token') || urlString.includes('error')) {
            console.log('URL contains Supabase auth parameters');
        }
        
        checkUrlManually();
        
        // Also check session after a longer delay to allow for processing
        setTimeout(() => {
            supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
                console.log('Delayed session check:', { session: !!session, error });
                if (session) {
                    console.log('Session found after delay:', session);
                    messageDiv.innerHTML = '<div class="success">Reset link validated. You can now set your new password.</div>'
                }
            });
        }, 2000);
        
        // Enhanced URL checking - handle various redirect scenarios
        function checkUrlManually() {
            console.log('Full URL:', window.location.href);
            console.log('Hash:', window.location.hash);
            console.log('Search:', window.location.search);
            
            // Check hash parameters
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const queryParams = new URLSearchParams(window.location.search);
            
            console.log('Hash parameters:', Object.fromEntries(hashParams));
            console.log('Query parameters:', Object.fromEntries(queryParams));
            
            const accessToken = hashParams.get('access_token') || queryParams.get('access_token');
            const refreshToken = hashParams.get('refresh_token') || queryParams.get('refresh_token');
            const type = hashParams.get('type') || queryParams.get('type');
            const error = hashParams.get('error') || queryParams.get('error');
            const errorDescription = hashParams.get('error_description') || queryParams.get('error_description');
            const code = hashParams.get('code') || queryParams.get('code');
            
            console.log('Detected parameters:', { accessToken: !!accessToken, refreshToken: !!refreshToken, type, error, code: !!code });
            
            // Handle code parameter - let Supabase handle the exchange automatically
            if (code && !error) {
                console.log('Found authorization code, letting Supabase handle session detection...');
                messageDiv.innerHTML = '<div style="text-align: center; color: #666;">Processing authorization code...</div>';
                
                // Let Supabase's detectSessionInUrl handle this automatically
                // Check for session after a short delay
                setTimeout(() => {
                    supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
                        console.log('Session check after code detection:', { session: !!session, error });
                        if (session) {
                            console.log('Session found after code processing:', session);
                            messageDiv.innerHTML = '<div class="success">Reset link validated. You can now set your new password.</div>';
                        } else if (error) {
                            console.error('Session error after code:', error);
                            messageDiv.innerHTML = `<div class="error">Failed to process reset link. Please request a new password reset.<br><small>Debug: ${error.message}</small></div>`;
                            document.getElementById('resetForm').style.display = 'none';
                        } else {
                            console.log('No session yet, waiting longer...');
                            // Try once more after a longer delay
                            setTimeout(() => {
                                supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
                                    if (session) {
                                        console.log('Session found after extended wait:', session);
                                        messageDiv.innerHTML = '<div class="success">Reset link validated. You can now set your new password.</div>';
                                    } else {
                                        console.error('No session found after processing code');
                                        messageDiv.innerHTML = `<div class="error">Failed to process reset link. Please request a new password reset.<br><small>Debug: Session not established</small></div>`;
                                        document.getElementById('resetForm').style.display = 'none';
                                    }
                                });
                            }, 2000);
                        }
                    });
                }, 1000);
                return;
            }
            
            // If no tokens found immediately, wait for potential redirect/hash update
            if (!accessToken && !error && !code) {
                console.log('No tokens found immediately - waiting for potential redirect...');
                messageDiv.innerHTML = '<div style="text-align: center; color: #666;">Processing reset link... Please wait.</div>';
                
                // Wait and re-check multiple times for tokens to appear
                let attempts = 0;
                const maxAttempts = 10;
                const checkInterval = setInterval(() => {
                    attempts++;
                    console.log(`Attempt ${attempts}: Re-checking for tokens...`);
                    
                    // Re-check hash and query parameters
                    const newHashParams = new URLSearchParams(window.location.hash.substring(1));
                    const newQueryParams = new URLSearchParams(window.location.search);
                    const newAccessToken = newHashParams.get('access_token') || newQueryParams.get('access_token');
                    const newError = newHashParams.get('error') || newQueryParams.get('error');
                    const newErrorDescription = newHashParams.get('error_description') || newQueryParams.get('error_description');
                    
                    console.log(`Attempt ${attempts} - Hash:`, Object.fromEntries(newHashParams));
                    console.log(`Attempt ${attempts} - Query:`, Object.fromEntries(newQueryParams));
                    
                    if (newAccessToken) {
                        clearInterval(checkInterval);
                        console.log('Tokens found after waiting!');
                        supabaseClient.auth.setSession({
                            access_token: newAccessToken,
                            refresh_token: newHashParams.get('refresh_token') || newQueryParams.get('refresh_token') || ''
                        }).then(({ error, data }) => {
                            if (error) {
                                console.error('Session setup error:', error);
                                messageDiv.innerHTML = `<div class="error">Invalid or expired reset link. Please request a new password reset from the RT app.<br><small>Debug: ${error.message}</small></div>`
                                document.getElementById('resetForm').style.display = 'none'
                            } else {
                                console.log('Session setup successful:', data);
                                messageDiv.innerHTML = '<div class="success">Reset link validated. You can now set your new password.</div>'
                            }
                        });
                    } else if (newError) {
                        clearInterval(checkInterval);
                        console.error('Error found in URL:', newError, newErrorDescription);
                        messageDiv.innerHTML = `<div class="error">Reset link error: ${newErrorDescription || newError}</div>`
                        document.getElementById('resetForm').style.display = 'none'
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.log('No tokens found after maximum attempts');
                        
                        // Add diagnostic information
                        const diagnosticInfo = `
                            <div class="error">
                                <strong>Reset link processing failed</strong><br>
                                <small>
                                    <strong>Debug Information:</strong><br>
                                    • Page URL: ${window.location.href}<br>
                                    • Referrer: ${document.referrer || 'None'}<br>
                                    • Hash: ${window.location.hash || 'None'}<br>
                                    • Search: ${window.location.search || 'None'}<br><br>
                                    
                                    <strong>Possible causes:</strong><br>
                                    1. The email link may be going directly to this page instead of through Supabase<br>
                                    2. Supabase redirect URL configuration issue<br>
                                    3. Network/browser blocking the redirect<br><br>
                                    
                                    <strong>Try this test:</strong><br>
                                    <a href="https://lxcbundvozbcshjboloc.supabase.co/auth/v1/verify?token=test&type=recovery&redirect_to=https://ttrotter.com/road-trip/reset-password.html" 
                                       target="_blank" style="color: #007AFF;">
                                       Test Supabase redirect manually
                                    </a>
                                </small>
                            </div>
                        `;
                        
                        messageDiv.innerHTML = diagnosticInfo;
                        document.getElementById('resetForm').style.display = 'none';
                    }
                }, 500); // Check every 500ms
                return;
            }
            
            if (error) {
                console.error('URL contains error:', error, errorDescription);
                messageDiv.innerHTML = `<div class="error">Reset link error: ${errorDescription || error}</div>`
                document.getElementById('resetForm').style.display = 'none'
                return;
            }
            
            if (accessToken) {
                console.log('Found access token, attempting to set session');
                supabaseClient.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken || ''
                }).then(({ error, data }) => {
                    if (error) {
                        console.error('Manual session setup error:', error);
                        messageDiv.innerHTML = `<div class="error">Invalid or expired reset link. Please request a new password reset from the RT app.<br><small>Debug: ${error.message}</small></div>`
                        document.getElementById('resetForm').style.display = 'none'
                    } else {
                        console.log('Manual session setup successful:', data);
                        messageDiv.innerHTML = '<div class="success">Reset link validated. You can now set your new password.</div>'
                    }
                });
            }
        }

        // Add real-time password validation
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const password = document.getElementById('password').value
            const confirmPassword = this.value
            
            if (confirmPassword && password !== confirmPassword) {
                this.style.borderColor = '#dc3545'
            } else {
                this.style.borderColor = '#ddd'
            }
        })

        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const password = document.getElementById('password').value
            const confirmPassword = document.getElementById('confirmPassword').value
            const messageDiv = document.getElementById('message')
            const submitBtn = document.getElementById('submitBtn')
            
            // Clear previous messages
            messageDiv.innerHTML = ''
            
            // Validation
            if (password !== confirmPassword) {
                messageDiv.innerHTML = '<div class="error">Passwords do not match</div>'
                return
            }
            
            if (password.length < 6) {
                messageDiv.innerHTML = '<div class="error">Password must be at least 6 characters long</div>'
                return
            }
            
            // Disable button and show loading state
            submitBtn.disabled = true
            submitBtn.textContent = 'Updating Password...'
            
            try {
                console.log('Attempting to update password');
                const { error } = await supabaseClient.auth.updateUser({
                    password: password
                })
                
                if (error) {
                    console.error('Password update error:', error);
                    messageDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`
                    submitBtn.disabled = false
                    submitBtn.textContent = 'Update Password'
                } else {
                    console.log('Password updated successfully');
                    messageDiv.innerHTML = '<div class="success">Password updated successfully!</div>'
                    
                    // Hide form and show success instructions
                    document.getElementById('resetForm').style.display = 'none'
                    document.getElementById('successInstructions').style.display = 'block'
                    
                    // Sign out to ensure clean state
                    await supabaseClient.auth.signOut()
                }
            } catch (error) {
                console.error('Unexpected error:', error);
                messageDiv.innerHTML = `<div class="error">An unexpected error occurred: ${error.message || error}</div>`
                submitBtn.disabled = false
                submitBtn.textContent = 'Update Password'
            }
        })
    </script>
</body>
</html>